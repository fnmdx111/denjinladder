// ==UserScript==
// @name        denjinladder
// @version     1.0.1
// @author      FNMDX111
// @description Display iidx12.tk-style lamps for SNJ@KMZS, the unofficial DP difficulty table.
// @homepage    https://github.com/qwert42/denjinladder
// @supportURL  https://github.com/qwert42/denjinladder/issues
// @include     https://zasa.sakura.ne.jp/dp/*
// @require     https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.0.min.js
// @grant       GM_setValue
// @grant       GM_getValue
// @updateURL   https://github.com/qwert42/denjinladder/blob/master/dist/denjinladder.user.ts
// @downloadURL https://github.com/qwert42/denjinladder/blob/master/dist/denjinladder.user.ts
// ==/UserScript==

!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t){e.exports=jQuery},function(e,t){e.exports=function(e){if("string"!=typeof e)throw new Error("color has to be type of `string`");if("#"===e.substr(0,1))return{hex:e,alpha:1};var t=e.replace(/\s+/g,""),r=/(.*?)rgb(a)??\((\d{1,3}),(\d{1,3}),(\d{1,3})(,([01]|0??\.([0-9]{0,3})))??\)/.exec(t);if(!r)throw new Error("given color ("+e+") isn't a valid rgb or rgba color");var n=parseInt(r[3],10),o=parseInt(r[4],10),i=parseInt(r[5],10),a=r[6]?/([0-9\.]+)/.exec(r[6])[0]:"1",c=(i|o<<8|n<<16|1<<24).toString(16).slice(1);return"."===a.substr(0,1)&&(a=parseFloat("0"+a)),a=parseFloat(Math.round(100*a))/100,{hex:"#"+c.toString(16),alpha:a}}},function(e,t,r){"use strict";r.r(t);const n="https://arcana.nu/api/v1";var o=function(e,t,r,n){return new(r||(r=Promise))(function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function c(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(a,c)}s((n=n.apply(e,t||[])).next())})},i=function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},a=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return a},c=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(a(arguments[t]));return e},s=function(){function e(e,t){this.version=e,this.token=t,this.BASE_URL=n+"/iidx",this.header={mode:"cors",headers:{Authorization:"Bearer "+t}},this.getPlayBestsUrl=this.getPlayBestsUrl.bind(this),this.fetchBests=this.fetchBests.bind(this),this.fetch=this.fetch.bind(this)}return e.prototype.getPlayBestsUrl=function(){return o(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return[4,fetch(this.BASE_URL+"/"+this.version.toString()+"/",this.header).then(function(e){return e.json()})];case 1:return[2,e.sent()._links.my_bests]}})})},e.makeIndex=function(e,t){return new Map(e.map(function(e){return[t(e),e]}))},e.prototype.fetchBests=function(t,r,n){return o(this,void 0,void 0,function(){var o,a,c,s,u,l,f,d;return i(this,function(i){switch(i.label){case 0:return[4,fetch(t,this.header).then(function(e){return e.json()})];case 1:return o=i.sent(),a=o._items,c=o._related.charts,s=o._related.music,u=o._links._next,l=e.makeIndex(c,function(e){return e._id}),f=e.makeIndex(s,function(e){return e._id}),d=a.map(function(e){return Object.assign({},l.get(e.chart_id),f.get(e.music_id),e)}).filter(function(e){return n.some(function(t){return Object.getOwnPropertyNames(t).every(function(r){return t[r]===e[r]})})}),r(d),[2,u]}})})},e.makePlayerBestIdentifier=function(e){var t={DOUBLE:"DP",SINGLE:"SP"}[e.play_style],r={NORMAL:"N",HYPER:"H",ANOTHER:"A",BLACK:"L"}[e.difficulty];return e.title+"|*|"+t+r},e.prototype.fetch=function(t){return void 0===t&&(t=[{play_style:"DOUBLE"}]),o(this,void 0,void 0,function(){var r,n,o,a,s,u;return i(this,function(i){switch(i.label){case 0:return[4,this.getPlayBestsUrl()];case 1:return r=i.sent(),console.info(r+": started fetching player's bests."),n=[],o=function(e){return n.push(e)},[4,this.fetchBests(r,o,t)];case 2:a=i.sent(),s=1,i.label=3;case 3:return a?(console.debug(a+": fetched #"+s),[4,this.fetchBests(a,o,t)]):[3,5];case 4:return a=i.sent(),++s,[3,3];case 5:return u=[].concat.apply([],c(n)),[2,e.makeIndex(u,function(t){return e.makePlayerBestIdentifier(t)})]}})})},e}(),u=r(0),l=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return a},f=r(1),d=function(){function e(e){this.playerBests=e,this.render=this.render.bind(this),this.sort=this.sort.bind(this),this.retrievePlayerBestItem=this.retrievePlayerBestItem.bind(this)}return e.playerBestIdFrom=function(e,t){return e+"|*|DP"+t},e.lampColorFrom=function(e){var t=e?e.lamp:"NO_PLAY";return this.LAMP_TO_COLOR[t]},e.clearLamps=function(){u("span.lamp").remove()},e.prototype.retrievePlayerBestItem=function(t){var r=l(t.match(/(.+) \[([NHAL])]/),3),n=r[1],o=r[2];console.debug("Found "+n+" "+o);var i=e.playerBestIdFrom(n,o),a=this.playerBests.get(i);return console.debug("Found item by "+i+": "+a),a},e.prototype.render=function(){var t=this;e.clearLamps(),u("a.music span").each(function(r,n){var o=u(n).css("height");u(n).prepend(u('<span class="lamp"></span>').css({width:o,height:o,"background-color":e.lampColorFrom(t.retrievePlayerBestItem(n.innerText)),display:"inline-block"}))})},e.hexColorFromMusicAnchor=function(e){return f(u(e).find("span.lamp").css("background-color")).hex},e.sortMusicAnchors=function(t){var r=this;return u(t.children("a.music")).toArray().sort(function(t,n){var o=l([t,n].map(function(t){return e.LAMP_WEIGHTS[r.hexColorFromMusicAnchor(t)]}),2),i=o[0]-o[1];return 0===i?0:i<0?-1:1})},e.renderStatistics=function(t){var r=t.children("a.music").map(function(t,r){return e.COLOR_TO_LAMP[e.hexColorFromMusicAnchor(r)]}).toArray().reduce(function(e,t){var r;return Object.assign(e,((r={})[t]=(e[t]?e[t]:0)+1,r),{total:e.total+1})},{total:0}),n=t.contents().filter(function(e,t){return 3===t.nodeType})[0].nodeValue;return t.contents().filter(function(e,t){return 3===t.nodeType}).remove(),Object.getOwnPropertyNames(r).reduce(function(e,t){return e+" | "+t+": "+r[t]+" ("+(r[t]/r.total).toFixed(2)+")"},n)},e.prototype.sort=function(){u('input[value="m1"]').prop("checked")?u("div#main div").filter(function(e,t){return u(t).children("a.music").length>0}).each(function(t,r){var n=u(r);n.find("br").remove(),n.prepend(e.renderStatistics(n)),e.sortMusicAnchors(n).forEach(function(e){n.append("<br/>"),n.append(e)})}):console.warn("Denjinladder supports sorting only when simple mode is selected.")},e.LAMP_TO_COLOR={NO_PLAY:"#ffffff",FAILED:"#c0c0c0",ASSISTED_CLEAR:"#9595ff",EASY_CLEAR:"#98fb98",CLEAR:"#afeeee",HARD_CLEAR:"#ff6347",EX_HARD_CLEAR:"#ffd900",FULL_COMBO:"#ff8c00"},e.COLOR_TO_LAMP=Object.getOwnPropertyNames(e.LAMP_TO_COLOR).reduce(function(t,r){var n;return Object.assign(t,((n={})[e.LAMP_TO_COLOR[r]]=r,n))},{}),e.LAMP_WEIGHTS={"#ffffff":0,"#c0c0c0":1,"#9595ff":2,"#98fb98":3,"#afeeee":4,"#ff6347":5,"#ffd900":6,"#ff8c00":7},e}();function h(e){return{do:function(t){return t(e),e}}}var p=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return a},y=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e};function b(e){console.info("Rendering lamps...");var t=new d(e);t.render(),t.sort()}u('div.menu_head:contains("メニュー")').next().append(u('<li><a id="load-secret-data" href="#">Load Secret Data</a></li>'));var v,m=h(GM_getValue("PlayerBestsSavedKey")).do(function(e){return console.debug("Saved player bests: "+e)});m&&!u.isEmptyObject(m)&&b((v=m,new Map(JSON.parse(v)))),u("#load-secret-data").on("click",function(){return new s(25,"eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJ0b2tlbiIsImlhdCI6MTU0MzM5MzEwOSwic3ViIjoiY2hzYzQ2OThAZ21haWwuY29tIiwic2NvcGUiOiJtYWNoaW5lX2FjY2VzcyByaXZhbF93cml0ZSBzZXR0aW5nc19yZWFkIHNldHRpbmdzX3dyaXRlIn0=.zEzbkQRmVnQD9Cck2Jx7-7pz6zLlLnu83gLPfXLzztg=").fetch().then(function(e){console.info("Fetch completed: fetched "+e.size+" entries."),console.info("Updating latest entries into local storage..."),GM_setValue("PlayerBestsSavedKey",function(e){return h(JSON.stringify(y(e))).do(function(e){return console.debug("Serializing player bests... "+e)})}(e)),b(e)})})}]);